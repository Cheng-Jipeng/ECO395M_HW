---
title: "Exercise 3"
author: "Yuting Huang, Jipeng Cheng, Weidi Hou"
date: "4/5/2022"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
```

### Problem 1: What causes what?
 

```{r warning=FALSE, echo=FALSE, message=FALSE}

```



### Problem 2: Tree modeling: dengue cases

```{r warning=FALSE, echo=FALSE, message=FALSE}
library(RCurl)
library(tidyverse)
library(mosaic)
library(rpart)
library(rpart.plot)
library(rsample) 
library(randomForest)
library(gbm)

# Read data #
dengue = read.csv("https://raw.githubusercontent.com/Cheng-Jipeng/ECO395M/master/data/dengue.csv")
dengue$city = factor(dengue$city)
dengue$season = factor(dengue$season, levels=c('spring', 'summer', 'fall', 'winter'))
dengue$season = factor(dengue$season)
dengue = dengue %>%
  select(total_cases, city, season, specific_humidity, tdtr_k, precipitation_amt) %>%
  na.omit()
# train/test split #
dengue_split =  initial_split(dengue, prop=0.8)
dengue_train = training(dengue_split)
dengue_test  = testing(dengue_split)
# CART
dengue_tree = rpart(total_cases ~ city + season + specific_humidity + tdtr_k + 
                    precipitation_amt, data=dengue_train, 
                  control = rpart.control(cp = 0.01, minsplit=30))
### plotcp(dengue_tree) 
# random forest #
dengue_forest = randomForest(total_cases ~ city + season + specific_humidity + tdtr_k + 
                               precipitation_amt, data=dengue_train, importance = TRUE)
### plot(dengue_forest)
# boosting #
dengue_boost = gbm(total_cases ~ city + season + specific_humidity + tdtr_k + 
               precipitation_amt, data=dengue_train, cv.folds = 10,
             interaction.depth=4, n.trees=500, shrinkage=.05)
### gbm.perf(dengue_boost)

# compare RMSE on the test set #
cbind(modelr::rmse(dengue_tree, dengue_test), 
      modelr::rmse(dengue_forest, dengue_test),
      modelr::rmse(dengue_boost, dengue_test)) 
```

Use Kable to name columns in .Rmd. The results suggest that random forests mode have the best performance on the testing data.

```{r warning=FALSE, echo=FALSE, message=FALSE}
# Plot partial dependence functions #
partialPlot(dengue_forest, dengue_test, 'specific_humidity', las=1)
partialPlot(dengue_forest, dengue_test, 'precipitation_amt', las=1)
partialPlot(dengue_forest, dengue_test, 'season', las=1) 
```



### Problem 3: Predictive model building: green certification

```{r warning=FALSE, echo=FALSE, message=FALSE}

```



### Problem 4: Predictive model building: California housing

Our purpose is to build the best predictive model to forecast the median house value in California. According to the topic description, in the beginning, we have to conduct standardized processing for "totalRooms" and  totalBedrooms" by creating the new variables including "sdrooms" and "sdbedrooms". Then we utilized three different methods including Step wise, Random Forecast and boost, to build the best predictive model. 


```{r warning=FALSE, echo=FALSE, message=FALSE}
library(tidyverse)
library(randomForest)
library(mosaic)
library(foreach)
library(rpart)
library(modelr)
library(gbm)
library(pdp)
library(rsample)
library(ggplot2)
library(scales)
library(ggmap)
library(lubridate)
library(randomForest)

cahousing = read.csv("https://raw.githubusercontent.com/Cheng-Jipeng/ECO395M/master/data/CAhousing.csv")

head(cahousing)

cahousing = mutate(cahousing,
                 sdrooms=totalRooms/households,
                 sdbedrooms=totalBedrooms/households,
                 totalRooms=NULL,totalBedrooms=NULL)

cahousing_split = initial_split(cahousing, prop = 0.7)
cahousing_train = training(cahousing_split)
cahousing_test = testing(cahousing_split)

lm_medium = lm(medianHouseValue ~ longitude + latitude + housingMedianAge + sdrooms + sdbedrooms + population + medianIncome, data=cahousing_train)
lm_medium

#Choose a model by AIC in a Stepwise Algorithm
lm_step = step(lm_medium, 
                scope=~(.)^2)
lm_step

cahousing_tree = rpart(medianHouseValue ~ longitude + latitude + housingMedianAge + sdrooms + sdbedrooms + population + medianIncome, data=cahousing_train, control = rpart.control(cp = 0.00001))
cahousing_tree

cahousing_forest = randomForest(medianHouseValue ~ longitude + latitude + housingMedianAge + sdrooms + sdbedrooms + population + medianIncome, data=cahousing_train, importance=TRUE)
cahousing_forest

cahousing_boost = gbm(medianHouseValue ~ longitude + latitude + housingMedianAge + sdrooms + sdbedrooms + population + medianIncome, data=cahousing_train)
cahousing_boost
```

Now, we estimate their RMSE to find out which model is our best predictive model.

```{r warning=FALSE, echo=FALSE, message=FALSE}
rmse(lm_medium, cahousing_test)
rmse(lm_step, cahousing_test)
rmse(cahousing_tree, cahousing_test)
rmse(cahousing_forest, cahousing_test)
rmse(cahousing_boost, cahousing_test)
```

According to our results, we can find the Random Forecast model has lower RMSE, so we use this to build our best predictive model.

```{r warning=FALSE, echo=FALSE, message=FALSE}
y_hat = predict(cahousing_forest,cahousing)

cahousing = mutate(cahousing,
                   prediction = y_hat,
                   residuals = abs(medianHouseValue-y_hat))

register_google(key='AIzaSyCxfaeZOsiy02DxnEYVMPW4mIuRyz3hIes')

medianhouse = qmplot(x = longitude, 
              y = latitude, 
              data = cahousing, 
              geom = "point", 
              color = medianHouseValue,
              maptype = "watercolor",
              extent = "panel",
              darken=0.2,
              alpha = 0.1) +
  scale_alpha(guide = 'none')+
  labs(title="Figure 4-1: Actual Median House Value in California")
medianhouse

#prdiction graph
predictvalue = qmplot(x = longitude, 
              y = latitude, 
              data = cahousing, 
              geom = "point", 
              extent = "panel",
              color = prediction,
              maptype = "watercolor",
              darken=0.2,
              alpha = 0.1) +
  scale_alpha(guide = 'none')+
  labs(title="Figure 4-2: Prediction Value in California")
predictvalue

#residual graph
modelerror = qmplot(x = longitude, 
              y = latitude, 
              data = cahousing, 
              geom = "point", 
              color = residuals,
              extent = "panel",
              maptype = "watercolor",
              darken=0.2,
              alpha = 0.1) +
  labs(title="Figure 4-3: Model's error")+
  scale_alpha(guide = 'none')
modelerror
```

We can find that above graphs are perform well, because Figure1: Actual Median House Value in California are almost match with Figure 4-2: Prediction Value in California. Therefore, we can indicate the random forest is the best predictive model in this case. In conclusion, our predictive model is effective, then we may use this predictive model to forecast other states or area in United State.
